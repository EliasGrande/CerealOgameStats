// ==UserScript==
// @name           CerealOgameStats
// @description    Make alliance stats from ogame to post in forums
// @namespace      http://userscripts.org/users/68563/scripts
// @downloadURL    https://userscripts.org/scripts/source/134405.user.js
// @updateURL      https://userscripts.org/scripts/source/134405.meta.js
// @icon           http://s3.amazonaws.com/uso_ss/icon/134405/large.png
// @version        2.2.0
// @include        *://*.ogame.*/game/index.php?*page=alliance*
// ==/UserScript==
/*!

	CerealOgameStats

	Makes alliance stats from the ogame alliance memberdata and
	transforms it into a forum friendly code.

	Copyright (C) 2012 Elías Grande Cásedas

	This program is free software: you can redistribute it and/or modify
	it under the terms of the GNU General Public License as published by
	the Free Software Foundation, either version 3 of the License, or
	(at your option) any later version.

	This program is distributed in the hope that it will be useful,
	but WITHOUT ANY WARRANTY; without even the implied warranty of
	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
	GNU General Public License for more details.

	You should have received a copy of the GNU General Public License
	along with this program.  If not, see http://www.gnu.org/licenses/

*/
(function(){var d=window,j;try{if(unsafeWindow){d=unsafeWindow}}catch(h){}j=d.document;var f=function(n){var m=j.createElement("style");m.setAttribute("type","text/css");if(m.styleSheet){m.styleSheet.cssText=n}else{m.appendChild(j.createTextNode(n))}var e=j.getElementsByTagName("head")[0];e.appendChild(m)};f("#member-list {display:none;}");var b={ready:false,list:j.createElement("table"),wait:10};var k=function(){try{var m=j.getElementById("member-list");if(!m){throw 0}else{b.list.innerHTML=m.innerHTML;b.ready=true;delete b.wait;f("#member-list {display:table;}")}}catch(n){b.wait=Math.round(b.wait*1.1);var o=this;setTimeout(k,b.wait)}};k();var i={name:"CerealOgameStats",home:"http://userscripts.org/scripts/show/134405"};String.prototype.replaceAll=function(e,m){return this.split(e).join(m)};var g=function(p,q,o,m){if(m==0){return p.split(q[0]).join(o[0])}var n,e;e=p.split(q[m]);for(n in e){e[n]=g(e[n],q,o,m-1)}return e.join(o[m])};String.prototype.replaceMap=function(e){var m,p,o,n;p=new Array();o=new Array();n=0;for(m in e){p.push(m);o.push(e[m]);n++}if(n==0){return this}else{return g(this,p,o,n-1)}};String.prototype.trimNaN=function(){return this.replace(/^\D*(\d)/,"$1").replace(/(\d)\D*$/,"$1")};var a=function(){var s=function(){this.getMeta("version","ogame-version",null);this.getMeta("language","ogame-language","en");this.getMeta("timestamp","ogame-timestamp",null);this.getMeta("universe","ogame-universe",null);this.getMeta("alliance_id","ogame-alliance-id",null)};s.prototype={getMeta:function(D,E,F){try{this[D]=j.querySelector('meta[name="'+E+'"]').getAttribute("content")}catch(G){this[D]=F}}};var q=new s();var z={id:function(D){return i.name+"_"+q.universe+"_"+q.alliance_id+"_"+D},set:function(G,D){var E=this.id(G);try{d.localStorage.setItem(E,D)}catch(F){d.localStorage[E]=D}return D},get:function(G){var D=this.id(G);try{return d.localStorage.getItem(D)}catch(E){var F=d.localStorage[D];return(F=="undefined")?null:F}}};var u=function(){this.lc={}};u.prototype={get:function(D){if(this.lc[D]){return this.lc[D]}return D},set:function(E){for(var D in E){this.lc[D]=E[D]}},number:function(I){var H,D,G,E;H=I+"";D=H.split(".");G=D[0];E=D.length>1?this.lc.s_dec+D[1]:"";var F=/(\d+)(\d{3})/;while(F.test(G)){G=G.replace(F,"$1"+this.lc.s_tho+"$2")}return G+E},date:function(D){return D.trimNaN().split(/\D+/).join(this.lc.s_dat)},time:function(D){return D.trimNaN().split(/\D+/).join(this.lc.s_tim)},period:function(J){var E,I,H,D,G=parseInt(J),F="",K=0;E=Math.floor(G/604800);G-=E*604800;I=Math.floor(G/86400);G-=I*86400;H=Math.floor(G/3600);G-=H*3600;D=Math.floor(G/60);G-=D*60;if(E>0){F+=this.number(E)+this.lc.a_wee+" ";K++}if(I>0){F+=this.number(I)+this.lc.a_day+" ";K++}if(H>0||K<1||D+G<1){F+=this.number(H)+this.lc.a_hou+" ";K++}if(D>0||K<2||(K==2&&G<1)){F+=this.number(D)+this.lc.a_min+" ";K++}if(G>0||K<3){F+=this.number(G)+this.lc.a_sec}return F.trim()}};var t=new u();var C=function(D){return t.get(D)};t.set({s_dec:".",s_tho:",",s_dat:"/",s_tim:":",a_wee:"w",a_day:"d",a_hou:"h",a_min:"m",a_sec:"s",b_sel:"Select",b_del:"Erase",b_get:"Get from this page",b_sav:'Save as "Old data"',b_loa:"Load saved data",t_odt:"Old data",t_ndt:"New data",t_fmt:"Format",t_col:"Colors",t_inc:"Include",t_out:"Statistics (code)",t_stb:"Status",t_pre:'Preview (using "Dark background" colors)',p_ago:"{period} ago",p_now:"now",c_dbg:"Dark background",c_lbg:"Light background",e_nod:"No old data",e_nnd:"No new data",e_odf:"The old data has wrong format",e_ndf:"The new data has wrong format",e_unk:"Unexpected error",e_ndt:"No data",e_wft:"Wrong format",w_dne:"Done",w_pcs:"Processing",o_tdt:"Evolution of the alliance since {oldDate} to {newDate}",o_tet:"Elapsed time",o_tas:"Alliance summary",o_ptl:"Total points",o_ppm:"Points per member",o_tts:"Top 3 by score",o_ttp:"Top 3 by percent",o_ttg:"Top 3 by gained positions",o_trs:"Score rank",o_trp:"Percent rank",o_trg:"Gained positions rank",o_tsc:"Special cases",o_cnm:"new member",o_cla:"leaves the alliance",o_bdg:"banned",o_bdq:"unbanned",o_ldt:"Latest data (for future statistics)",o_abt:"Statistics performed with {link}",e_oga:"OGame Error, reload this page may fix it"});if(/es|ar|mx/.test(q.language)){t.set({s_dec:",",s_tho:".",a_wee:"s",a_day:"d",a_hou:"h",a_min:"m",a_sec:"s",b_sel:"Seleccionar",b_del:"Borrar",b_get:"Obtener de esta página",b_sav:'Guardar como "Datos antiguos"',b_loa:"Cargar datos guardados",t_odt:"Datos antiguos",t_ndt:"Datos nuevos",t_fmt:"Formato",t_col:"Colores",t_inc:"Incluir",t_out:"Estadísticas (código)",t_stb:"Estado",t_pre:'Previsualización (usando colores de "Fondo oscuro")',p_ago:"hace {period}",p_now:"ahora",c_dbg:"Fondo oscuro",c_lbg:"Fondo claro",e_nod:"No hay datos antiguos",e_nnd:"No hay datos nuevos",e_odf:"Los datos antiguos tienen un formato erróneo",e_ndf:"Los datos nuevos tienen un formato erróneo",e_unk:"Error inesperado",e_ndt:"Sin datos",e_wft:"Formato erróneo",w_dne:"Terminado",w_pcs:"Procesando",o_tdt:"Evolución de la alianza desde el {oldDate} hasta el {newDate}",o_tet:"Tiempo transcurrido",o_tas:"Resumen de la alianza",o_ptl:"Puntos totales",o_ppm:"Puntos por miembro",o_tts:"Top 3 por puntos",o_ttp:"Top 3 por porcentaje",o_ttg:"Top 3 por posiciones subidas",o_trs:"Ranking por puntos",o_trp:"Ranking por porcentaje",o_trg:"Ranking por posiciones subidas",o_tsc:"Casos especiales",o_cnm:"nuevo miembro",o_cla:"abandona la alianza",o_bdg:"baneado",o_bdq:"desbaneado",o_ldt:"Datos más recientes (para futuras estadísticas)",o_abt:"Estadísticas realizadas con {link}",e_oga:"Error de OGame, recargar esta página puede arreglarlo"})}else{if(/fr/.test(q.language)){t.set({s_dec:".",s_tho:",",s_dat:"/",s_tim:":",a_wee:"s",a_day:"j",a_hou:"h",a_min:"m",a_sec:"s",b_sel:"Sélectionner",b_del:"Effacer",b_get:"Recharger de cette page",b_sav:'Sauvegarder comme anciennes données"',b_loa:"Charger anciennes données",t_odt:"Anciennes données",t_ndt:"Nouvelles données",t_fmt:"Format",t_col:"Couleur",t_inc:"Inclure",t_out:"Statistiques (code)",t_stb:"Statut",t_pre:"Aperçu (en utilisant l’arrière plan foncé)",p_ago:"{period} depuis le début",p_now:"maintenant",c_dbg:"Arrière plan foncé",c_lbg:"Arrière plan clair",e_nod:"Pas d'anciennes données",e_nnd:"Pas de nouvelles données",e_odf:"Les anciennes données ont un mauvais format",e_ndf:"Les nouvelles données ont un mauvais format",e_unk:"Erreur inattendu",e_ndt:"Pas de données",e_wft:"Mauvais format",w_dne:"Prêt",w_pcs:"Traitement en cours",o_tdt:"Évolution de l'alliance du {oldDate} au {newDate}",o_tet:"Temps passé",o_tas:"Résumé de l'Alliance ",o_ptl:"Points Totaux",o_ppm:"Points par membres",o_tts:"Top 3 par score",o_ttp:"Top 3 par pourcentage",o_ttg:"Top 3 par places gagnées",o_trs:"Rang par score",o_trp:"Rang par pourcentage",o_trg:"Rang par places gagnées",o_tsc:"Cas spéciaux",o_cnm:"Nouveaux Membres",o_cla:"A quitter l'alliance",o_bdg:"Banni",o_bdq:"Débanni",o_ldt:"Dernières données (pour statistiques futures)",o_abt:"Statistiques obtenues avec {link}",e_oga:"Erreur OGame, recharger la page peut régler le problème"})}}var B=function(){this.names=new Array();this.colors=new Array();this.selected=null};B.prototype={add:function(E,D){this.names.push(E);this.colors.push(D)},select:function(D){this.selected=this.colors[D]},replace:function(D){return D.replaceMap(this.selected)}};var r=new B();r.add(C("c_dbg"),{"{nameColor}":"white","{growsColor}":"#00FF40","{decreasesColor}":"#ED7010","{remainsColor}":"#00DDDD"});r.add(C("c_lbg"),{"{nameColor}":"purple","{growsColor}":"green","{decreasesColor}":"red","{remainsColor}":"blue"});var o={diffScore:function(D,G){var F=G-D;var E=((G/D)-1)*100;return{score:F,percent:E}}};var m=function(){this.formats=new Array();this.selected=null;this.escapeMap={"[":"[[u][/u]","]":"[u][/u]]"};this.lastReplace={"{grows}":"\u00BB","{decreases}":"\u00AB","{remains}":"\u007E","{remainsNo}":"\u00D8","{up}":"\u2191","{down}":"\u2193","{rank}":"#","{\\":"{","\\}":"}"};this.layout={sectionStart:"[size=big]{title}[/size]",sectionEnd:"\n\n",dateTime:"{date} ([i]{time}[/i])",header:"[b]{title}[/b]\n{elapsedTitle}: {elapsedTime}\n\n",allianceLine:"\n[color={diffColor}]{diff}[/color] [b][color={nameColor}]{title}[/color][/b] - {newScore} ([b][color={diffColor}]{diffScore}[/color][/b]) ([b][color={diffColor}]{diffPercent}[/color][/b] [color={diffColor}][size=small]%[/size][/color])",top3ScoreLine:"\n[color={diffColor}]{position} {diff} [/color] [color={nameColor}][b]{name}[/b][/color] ([b][color={diffColor}]{diffScore}[/color][/b])",top3PercentLine:"\n[color={diffColor}]{position} {diff} [/color] [color={nameColor}][b]{name}[/b][/color] ([b][color={diffColor}]{diffPercent}[/color][/b] [color={diffColor}][size=small]%[/size][/color])",top3PositionsLine:"\n[color={diffColor}]{position} {diff} [/color] [color={nameColor}][b]{name}[/b][/color] ([b][color={diffColor}]{diffPos}[/color][/b])",rankLine:"\n[color={diffColor}]{position} {diff} [/color][color={nameColor}][b]{name}[/b][/color] - {newScore} ([b][color={diffColor}]{diffScore}[/color][/b]) ([b][color={diffColor}]{diffPercent}[/color][/b] [color={diffColor}][size=small]%[/size][/color])",rank:" [size=small]{rank}[/size]{newPos} ([b][color={diffColor}]{diffPos}[/color][/b])",rankNoDiff:" [size=small]{rank}[/size]{newPos} ([b][color={remainsColor}]{remainsNo}[/color][/b])",rankLineNoDiff:"\n[color={diffColor}]{position} {diff} [/color][color={nameColor}][b]{name}[/b][/color] - {oldScore} ([b][color={remainsColor}]{remainsNo}[/color][/b])",from0Member:"\n[color={growsColor}]{grows} [/color] [color={nameColor}][b]{name}[/b][/color] - [b][color={growsColor}]{score}[/color][/b] [size=small]({reason})[/size]",to0Member:"\n[color={decreasesColor}]{decreases} [/color] [color={nameColor}][b]{name}[/b][/color] - [b][color={decreasesColor}]{score}[/color][/b] [size=small]({reason})[/size]",scriptData:"\n[i]{scriptDataTitle}:[/i]\n[spoiler][code]{scriptData}[/code][/spoiler]",scriptLink:"\n[i]"+C("o_abt").replace("{link}","[url={scriptHome}]{scriptName}[/url]")+"[/i]"}};m.prototype={add:function(D,E){this.formats.push({name:D,patterns:E,escapeMap:(arguments.length>2)?arguments[2]:false})},select:function(D){this.selected=this.formats[D]},escape:function(D){if(this.selected.escapeMap){return D.replaceMap(this.selected.escapeMap)}else{return D.replaceMap(this.escapeMap)}},diff:function(E,F){var D=E;if(F<0){D=D.replaceMap({"{diffColor}":"{decreasesColor}","{diff}":"{decreases}"})}else{if(F>0){D=D.replaceMap({"{diffColor}":"{growsColor}","{diff}":"{grows}"})}else{D=D.replaceMap({"{diffColor}":"{remainsColor}","{diff}":"{remains}"})}}return D},header:function(D){return this.layout.header.replaceMap({"{title}":C("o_tdt").replaceMap({"{oldDate}":this.layout.dateTime.replaceMap({"{date}":D.oldDate,"{time}":D.oldTime}),"{newDate}":this.layout.dateTime.replaceMap({"{date}":D.newDate,"{time}":D.newTime})}),"{elapsedTitle}":C("o_tet"),"{elapsedTime}":this.escape(t.period(D.newTimestamp-D.oldTimestamp))})},alliance:function(D){if(D.oldScore==0){return""}return this.layout.sectionStart.replaceAll("{title}",C("o_tas"))+this.diff(this.layout.allianceLine,D.diffScore).replaceMap({"{title}":C("o_ptl"),"{newScore}":D.formatted.newScore,"{diffScore}":D.formatted.diffScore,"{diffPercent}":D.formatted.diffPercent})+this.diff(this.layout.allianceLine,D.diffMemberScore).replaceMap({"{title}":C("o_ppm"),"{newScore}":D.formatted.newMemberScore,"{diffScore}":D.formatted.diffMemberScore,"{diffPercent}":D.formatted.diffMemberPercent})+this.layout.sectionEnd},position:function(I,D){var E=I+"",H=(E).length,G=(D+"").length;for(var F=H;F<G;F++){E="0"+E}return E},top3:function(G,I,K,D){var F=(this.layout.sectionStart+"").replace("{title}",K);var E=Math.min(G.length,3);var H,J;for(H=0;H<E;H++){J=G[H];F=F+this.diff(D,J.diffScore).replaceMap({"{position}":this.position(H+1,E),"{name}":this.escape(J.name),"{diffPos}":J.formatted.diffPos.replaceMap({"+":"{up}","-":"{down}"})}).replaceAll("{"+I+"}",J.formatted[I])}return F+this.layout.sectionEnd},rank:function(F,J){var E=(this.layout.sectionStart+"").replace("{title}",J);var D=F.length;var G,I;for(G=0;G<D;G++){I=F[G];var H=(I.diffScore==0)?this.layout.rankLineNoDiff:this.layout.rankLine;E=E+this.diff(H,I.diffScore).replaceMap({"{position}":this.position(G+1,D),"{name}":this.escape(I.name),"{oldScore}":I.formatted.oldScore,"{newScore}":I.formatted.newScore,"{diffScore}":I.formatted.diffScore,"{diffPercent}":I.formatted.diffPercent});H=(I.diffPos==0)?this.layout.rankNoDiff:this.layout.rank;E=E+this.diff(H,I.diffPos).replaceMap({"{newPos}":I.formatted.newPos,"{diffPos}":I.formatted.diffPos.replaceMap({"+":"{up}","-":"{down}"})})}return E+this.layout.sectionEnd},specialCases:function(F,G){if((F.length+G.length)==0){return""}var D=this.layout.sectionStart.replace("{title}",C("o_tsc"));var E,H;for(E in G){H=G[E];D=D+this.layout.from0Member.replaceMap({"{name}":this.escape(H.name),"{score}":H.score,"{reason}":H.reason})}for(E in F){H=F[E];D=D+this.layout.to0Member.replaceMap({"{name}":this.escape(H.name),"{score}":H.score,"{reason}":H.reason})}return D+this.layout.sectionEnd},format:function(E,G,L,H,K,I){var F=this.header(G);if(E.alliance){F=F+this.alliance(G)}var J="";var M="";var P="";var D="";var N="";var O="";if(L.length>0){L=L.sort(function(R,Q){return(R.diffScore>=Q.diffScore)?-1:1});if(E.top3Score&&(L.length>5||!E.score)){J=this.top3(L,"diffScore",C("o_tts"),this.layout.top3ScoreLine)}if(E.score){D=this.rank(L,C("o_trs"))}L=L.sort(function(R,Q){return(R.diffPercent>=Q.diffPercent)?-1:1});if(E.top3Percent&&(L.length>5||!E.percent)){M=this.top3(L,"diffPercent",C("o_ttp"),this.layout.top3PercentLine)}if(E.percent){N=this.rank(L,C("o_trp"))}L=L.sort(function(R,Q){return(R.diffPos>=Q.diffPos)?-1:1});if(E.top3Positions&&(L.length>5||!E.positions)){P=this.top3(L,"diffPos",C("o_ttg"),this.layout.top3PositionsLine)}if(E.positions){O=this.rank(L,C("o_trg"))}}F=F+J+M+P+D+N+O;if(E.special){F=F+this.specialCases(H,K)}if(E.data){F=F+this.layout.scriptData.replace("{scriptDataTitle}",C("o_ldt"))}F=F+this.layout.scriptLink;F=F.replaceMap(this.selected.patterns).replaceMap(r.selected).replaceMap({"{scriptName}":i.name,"{scriptHome}":i.home}).replaceMap(this.lastReplace).replace("{scriptData}",I.replaceMap({"<":"\\u003C",">":"\\u003E","[":"\\u005B","]":"\\u005D"}));return F.trim()}};var w=new m();w.add("phpBB",{"[size=big]":"[size=20]","[size=small]":"[size=10]"});w.add("phpBB3",{"[size=big]":"[size=140]","[size=small]":"[size=80]"});w.add("SMF",{"[size=big]":"[size=14pt]","[size=small]":"[size=7pt]"});w.add("vBulletin",{"[size=big]":"[size=4]","[size=small]":"[size=1]"});w.add("HTML",{"{grows}":"&raquo;","{decreases}":"&laquo;","{remains}":"&sim;","{remainsNo}":"&Oslash;","{up}":"&uarr;","{down}":"&darr;","[size=big]":'<span style="font-size: 140%;">',"[size=small]":'<span style="font-size: 80%;">',"[/size]":"</span>","[color={":'<span style="color: {',"Color}]":'Color}">',"[/color]":"</span>","[b]":"<b>","[/b]":"</b>","[i]":"<i>","[/i]":"</i>","\n":"<br />\n","[spoiler]":"<div>","[/spoiler]":"</div>","[code]":'<textarea onclick="this.select();" rows="5" cols="20">',"[/code]":"</textarea>","[url={scriptHome}]{scriptName}[/url]":'<a href="{scriptHome}">{scriptName}</a>'},{"&":"&amp;","<":"&lt;",">":"&gt;"});var y=function(){};y.prototype={reset:function(){this.allyInfo={oldCount:0,oldScore:0,newCount:0,newScore:0};this.membersInfo=new Array();this.oldMembersInfo=new Array();this.newMembersInfo=new Array();this.to0MembersInfo=new Array();this.from0MembersInfo=new Array()},readData:function(G,F){var D,E=JSON.parse(G);this.allyInfo[F+"Timestamp"]=E.timestamp;this.allyInfo[F+"Date"]=E.strDate;this.allyInfo[F+"Time"]=E.strTime;for(D in E.members){this[F+"MembersInfo"].push({id:("i" in E.members[D])?E.members[D].i:-1,name:D,score:E.members[D].s,pos:E.members[D].p,coord:E.members[D].c,date:E.members[D].d,noPartner:true});this.allyInfo[F+"Count"]++;this.allyInfo[F+"Score"]=this.allyInfo[F+"Score"]+E.members[D].s}return E},merge:function(){var I,G,L,F,H,D,J;L=this.allyInfo.oldCount;for(I in this.newMembersInfo){H=this.newMembersInfo[I];for(G=0;G<L;G++){F=this.oldMembersInfo[G];if((F.noPartner)&&(((F.id>=0)&&(F.id==H.id))||(F.name==H.name)||(F.coord==H.coord))){break}}if(G!=L){this.oldMembersInfo[G].noPartner=false;this.newMembersInfo[I].noPartner=false;if(H.score==0){this.to0MembersInfo.push({name:H.name,score:t.number(F.score),reason:C("o_bdg")})}else{if(F.score==0){this.from0MembersInfo.push({name:H.name,score:t.number(H.score),reason:C("o_bdq")})}else{J=o.diffScore(F.score,H.score);D={name:H.name,oldScore:F.score,newScore:H.score,oldPos:F.pos,newPos:H.pos,diffPos:F.pos-H.pos,diffScore:J.score,diffPercent:J.percent};D.formatted={oldScore:t.number(D.oldScore),newScore:t.number(D.newScore),oldPos:t.number(D.oldPos.toFixed()),newPos:t.number(D.newPos.toFixed()),diffPos:((D.diffPos<0)?"":"+")+t.number(D.diffPos.toFixed()),diffScore:((D.diffScore<0)?"":"+")+t.number(D.diffScore.toFixed()),diffPercent:((D.diffPercent<0)?"":"+")+t.number(D.diffPercent.toFixed(2))};this.membersInfo.push(D)}}}}var E,K;for(K in this.newMembersInfo){E=this.newMembersInfo[K];if(E.noPartner){this.from0MembersInfo.push({name:E.name,score:t.number(E.score),reason:C("o_cnm")})}}for(K in this.oldMembersInfo){E=this.oldMembersInfo[K];if(E.noPartner){this.to0MembersInfo.push({name:E.name,score:t.number(E.score),reason:C("o_cla")})}}this.to0MembersInfo.sort(function(N,M){return parseInt(N.score)-parseInt(M.score)});this.from0MembersInfo.sort(function(N,M){return parseInt(M.score)-parseInt(N.score)});delete this.oldMembersInfo;delete this.newMembersInfo;J=o.diffScore(this.allyInfo.oldScore,this.allyInfo.newScore);this.allyInfo.diffScore=J.score;this.allyInfo.diffPercent=J.percent;this.allyInfo.oldMemberScore=this.allyInfo.oldScore/this.allyInfo.oldCount;this.allyInfo.newMemberScore=this.allyInfo.newScore/this.allyInfo.newCount;J=o.diffScore(this.allyInfo.oldMemberScore,this.allyInfo.newMemberScore);this.allyInfo.diffMemberScore=J.score;this.allyInfo.diffMemberPercent=J.percent;this.allyInfo.formatted={oldScore:t.number(this.allyInfo.oldScore),newScore:t.number(this.allyInfo.newScore),diffScore:((this.allyInfo.diffScore<0)?"":"+")+t.number(this.allyInfo.diffScore.toFixed()),diffPercent:((this.allyInfo.diffPercent<0)?"":"+")+t.number(this.allyInfo.diffPercent.toFixed(2)),oldMemberScore:t.number(this.allyInfo.oldMemberScore.toFixed()),newMemberScore:t.number(this.allyInfo.newMemberScore.toFixed()),diffMemberScore:((this.allyInfo.diffMemberScore<0)?"":"+")+t.number(this.allyInfo.diffMemberScore.toFixed()),diffMemberPercent:((this.allyInfo.diffMemberPercent<0)?"":"+")+t.number(this.allyInfo.diffMemberPercent.toFixed(2))}},doIt:function(F){F.setStats();F.setPreview();w.select(parseInt(F.selectFormat.selectedIndex));r.select(parseInt(F.selectColors.selectedIndex));F.setOkStatus(C("w_pcs")+"...");this.reset();var G,I,E=false;if(F.oldList.value.trim()==""){F.setErrorStatus(C("e_nod"));F.setTitle("old",C("e_ndt"),false);E=true}if(!E){try{G=this.readData(F.oldList.value,"old");I=G.strDate+" (<i>"+G.strTime+"</i>) &rarr; "+((q.timestamp==G.timestamp)?C("p_now"):C("p_ago").replace("{period}",t.period(q.timestamp-G.timestamp)));if(this.oldMembersInfo.length==0||/NaN|undefined/.test(I)){throw 0}F.setTitle("old",I,true)}catch(H){F.setTitle("old",C("e_wft"),false);F.setErrorStatus(C("e_odf"));E=true}}if(F.newList.value.trim()==""){F.setErrorStatus(C("e_nnd"));F.setTitle("new",C("e_ndt"),false);return}try{G=this.readData(F.newList.value,"new");I=G.strDate+" (<i>"+G.strTime+"</i>) &rarr; "+((q.timestamp==G.timestamp)?C("p_now"):C("p_ago").replace("{period}",t.period(q.timestamp-G.timestamp)));if(this.newMembersInfo.length==0||/NaN|undefined/.test(I)){throw 0}F.setTitle("new",I,true);if(E){return}}catch(H){F.setErrorStatus(C("e_ndf"));return}try{this.merge();var D={alliance:F.doAlliance.checked,top3Score:F.doTop3Score.checked,top3Percent:F.doTop3Percent.checked,top3Positions:F.doTop3Positions.checked,score:F.doScore.checked,percent:F.doPercent.checked,positions:F.doPositions.checked,special:F.doSpecial.checked,data:F.doData.checked};F.setStats(w.format(D,this.allyInfo,this.membersInfo,this.to0MembersInfo,this.from0MembersInfo,F.newList.value.trim()));D.data=false;w.select(w.formats.length-1);r.select(0);F.setPreview(w.format(D,this.allyInfo,this.membersInfo,this.to0MembersInfo,this.from0MembersInfo,F.newList.value.trim()).replaceAll(w.selected.patterns["[size=small]"],"<span>").replaceAll(w.selected.patterns["[size=big]"],'<span style="font-size:20px">'));F.setOkStatus(C("w_dne"))}catch(H){F.setErrorStatus(C("e_unk")+": "+H)}}};var v=new y();var e=function(){};e.prototype={addTextarea:function(E){var D=j.createElement("textarea");D.setAttribute("cols","120");D.setAttribute("rows","40");D.setAttribute("class","textBox");E.appendChild(D);return D},addSelect:function(E){var D=j.createElement("select");D.setAttribute("class","dropdown");E.appendChild(D);return D},addOption:function(G,F,E){var D=j.createElement("option");D.appendChild(j.createTextNode(G));D.setAttribute("value",F);E.appendChild(D);return D},addAnchor:function(E,F){var D=j.createElement("a");D.setAttribute("href","javascript:void(0);");D.appendChild(j.createTextNode(F));E.appendChild(D);return D},addTitle:function(E,F){var D=j.createElement("b");D.appendChild(j.createTextNode(F));D.setAttribute("style","display:block;font-size:12px");E.appendChild(D);return D},newCell:function(){var D=j.createElement("td");return D},addText:function(E,F){var D=j.createTextNode(F);E.appendChild(D);return D},addBr:function(D){D.appendChild(j.createElement("br"))},addEvent:function(F,E,D){F.addEventListener(E,D,false)},addOnChange:function(E,D){E.addEventListener("change",D,false);E.addEventListener("keyup",D,false)},addCheckbox:function(F,J,K,I,H){var D=j.createElement("input");D.setAttribute("type","checkbox");D.setAttribute("id",i.name+"_"+K);D.setAttribute("style","cursor:pointer;");F.appendChild(D);var E=j.createElement("label");E.setAttribute("for",i.name+"_"+K);E.setAttribute("style","cursor:pointer;");E.innerHTML="&nbsp;"+J;F.appendChild(E);this.addBr(F);var G=z.get(K);D.checked=(G==null)?I:(parseInt(G)==1);z.set(K,(D.checked)?1:0);D.addEventListener("change",function(){z.set(K,(D.checked)?1:0);H()},false);E.addEventListener("mouseover",function(){E.setAttribute("class","undermark")},false);E.addEventListener("mouseout",function(){E.removeAttribute("class")},false);return D},makeTogleable:function(H,L,I){var J=j.createElement("a");J.setAttribute("href","javascript:void(0);");J.setAttribute("class",i.name+"_toggle_button");var E=H;var D=true;var G=function(){D=true;E.removeAttribute("style");I.setAttribute("class",I.getAttribute("class").replace("_toggle_bar_open","_toggle_bar_close"))};var K=function(){D=false;E.setAttribute("style","display:none;");I.setAttribute("class",I.getAttribute("class").replace("_toggle_bar_close","_toggle_bar_open"))};var F=function(){if(D){K()}else{G()}};I.setAttribute("class",I.hasAttribute("class")?I.getAttribute("class")+" "+i.name+"_toggle_bar_close":i.name+"_toggle_bar_close");I.addEventListener("click",F,false);F();L.setAttribute("style","position:relative;");L.appendChild(J);return{open:G,close:K,toggle:F}},addCss:f};var x=new e();x.addCss("#"+i.name+" textarea{width: 350px !important;height: 70px !important;margin: 0 !important;padding: 5px !important;}#"+i.name+" a{display: block !important;padding: 5px 0 0 0 !important;}#"+i.name+" select{width: 250px !important;}#"+i.name+" td{padding: 5px !important;text-align: left !important;}#"+i.name+" td.col2{width: 364px !important;}#"+i.name+" tr.tit td{line-height: 18px !important;}#"+i.name+"_preview{color: #6F9FC8 !important;border-top: 2px dotted #242E38 !important;padding-top: 15px !important;}#"+i.name+"_preview a{display: inline !important;padding: 0 !important;}."+i.name+"_toggle_button{background-color: transparent !important;background-image: url('http://gf2.geo.gfsrv.net/cdn71/fc7a8ede3499a0b19ea17613ff0cb1.gif') !important;display  : block !important;position : absolute !important;top      : 0 !important;right    : 0 !important;height   : 13px !important;width    : 20px !important;}."+i.name+"_toggle_bar_open,."+i.name+"_toggle_bar_close{cursor: pointer !important;}."+i.name+"_toggle_bar_open ."+i.name+"_toggle_button{background-position: 0 0 !important;}."+i.name+"_toggle_bar_close ."+i.name+"_toggle_button{background-position: 0 -18px !important;}."+i.name+"_toggle_bar_open:hover ."+i.name+"_toggle_button{background-position: -20px 0 !important;}."+i.name+"_toggle_bar_close:hover ."+i.name+"_toggle_button{background-position: -20px -18px !important;}");var p=function(N){var E,J,D,M,F,O,G,H,K,I;F=this;H=function(){F.doIt()};var L=/WebKit|Gecko|Presto/i.test(d.navigator.userAgent);this.table=j.createElement("table");this.table.setAttribute("cellpadding","0");this.table.setAttribute("cellspacing","0");this.table.setAttribute("class","members bborder");this.table.setAttribute("style","width:90%;");N.appendChild(this.table);E=j.createElement("tbody");this.table.appendChild(E);J=j.createElement("tr");J.setAttribute("class","alt tit");E.appendChild(J);D=x.newCell();x.addTitle(D,C("t_odt")+":");J.appendChild(D);D=x.newCell();D.setAttribute("class","col2");K=j.createElement("div");this.oldTitle=j.createElement("span");K.appendChild(this.oldTitle);D.appendChild(K);J.appendChild(D);I=J;J=j.createElement("tr");J.setAttribute("class","alt");E.appendChild(J);D=x.newCell();M=x.addAnchor(D,C("b_sel"));M.addEventListener("click",function(){F.oldList.select()},false);M=x.addAnchor(D,C("b_del"));M.addEventListener("click",function(){F.setOldList()},false);M=x.addAnchor(D,C("b_loa"));M.addEventListener("click",function(){F.load()},false);M=x.addAnchor(D,C("b_sav"));M.addEventListener("click",function(){F.save("old")},false);J.appendChild(D);D=x.newCell();D.setAttribute("class","col2");this.oldList=x.addTextarea(D);x.addOnChange(this.oldList,H,false);J.appendChild(D);if(L){x.makeTogleable(J,K,I)}J=j.createElement("tr");J.setAttribute("class","tit");E.appendChild(J);D=x.newCell();x.addTitle(D,C("t_ndt")+":");J.appendChild(D);D=x.newCell();D.setAttribute("class","col2");K=j.createElement("div");this.newTitle=j.createElement("span");K.appendChild(this.newTitle);D.appendChild(K);J.appendChild(D);I=J;J=j.createElement("tr");E.appendChild(J);D=x.newCell();M=x.addAnchor(D,C("b_sel"));M.addEventListener("click",function(){F.newList.select()},false);M=x.addAnchor(D,C("b_del"));M.addEventListener("click",function(){F.setNewList()},false);M=x.addAnchor(D,C("b_get"));M.addEventListener("click",function(){F.setNewListFromPage()},false);M=x.addAnchor(D,C("b_sav"));M.addEventListener("click",function(){F.save("new")},false);M.setAttribute("title",C("b_svt"));J.appendChild(D);D=x.newCell();D.setAttribute("class","col2");this.newList=x.addTextarea(D);x.addOnChange(this.newList,H,false);J.appendChild(D);if(L){x.makeTogleable(J,K,I)}J=j.createElement("tr");J.setAttribute("class","alt tit");E.appendChild(J);D=x.newCell();x.addTitle(D,C("t_fmt")+":");J.appendChild(D);D=x.newCell();D.setAttribute("class","col2");this.selectFormat=x.addSelect(D);for(O in w.formats){x.addOption(w.formats[O].name,O,this.selectFormat)}G=z.get("selectFormat");this.selectFormat.selectedIndex=(G==null)?0:parseInt(G);this.selectFormat.addEventListener("change",function(){z.set("selectFormat",F.selectFormat.selectedIndex+"");H()},false);J.appendChild(D);J=j.createElement("tr");J.setAttribute("class","tit");E.appendChild(J);D=x.newCell();x.addTitle(D,C("t_col")+":");J.appendChild(D);D=x.newCell();D.setAttribute("class","col2");this.selectColors=x.addSelect(D);for(O in r.names){x.addOption(r.names[O],O,this.selectColors)}G=z.get("selectColors");this.selectColors.selectedIndex=(G==null)?0:parseInt(G);this.selectColors.addEventListener("change",function(){z.set("selectColors",F.selectColors.selectedIndex+"");H()},false);J.appendChild(D);J=j.createElement("tr");J.setAttribute("class","alt");E.appendChild(J);D=x.newCell();D.setAttribute("colspan","2");D.setAttribute("class","col2");K=j.createElement("div");x.addTitle(K,C("t_inc")+":");D.appendChild(K);J.appendChild(D);I=J;J=j.createElement("tr");J.setAttribute("class","alt");E.appendChild(J);J.appendChild(x.newCell());D=x.newCell();D.setAttribute("class","col2");this.doAlliance=x.addCheckbox(D,C("o_tas"),"doAlliance",true,H);this.doTop3Score=x.addCheckbox(D,C("o_tts"),"doTop3Score",true,H);this.doTop3Percent=x.addCheckbox(D,C("o_ttp"),"doTop3Percent",true,H);this.doTop3Positions=x.addCheckbox(D,C("o_ttg"),"doTop3Positions",false,H);this.doScore=x.addCheckbox(D,C("o_trs"),"doScore",true,H);this.doPercent=x.addCheckbox(D,C("o_trp"),"doPercent",true,H);this.doPositions=x.addCheckbox(D,C("o_trg"),"doPositions",false,H);this.doSpecial=x.addCheckbox(D,C("o_tsc"),"doSpecial",true,H);this.doData=x.addCheckbox(D,C("o_ldt"),"doData",true,H);J.appendChild(D);if(L){x.makeTogleable(J,K,I)}J=j.createElement("tr");J.setAttribute("class","tit");E.appendChild(J);D=x.newCell();D.setAttribute("colspan","2");D.setAttribute("class","col2");K=j.createElement("div");x.addTitle(K,C("t_out")+":");D.appendChild(K);J.appendChild(D);I=J;J=j.createElement("tr");E.appendChild(J);D=x.newCell();M=x.addAnchor(D,C("b_sel"));M.addEventListener("click",function(){F.stats.select()},false);J.appendChild(D);D=x.newCell();D.setAttribute("class","col2");this.stats=x.addTextarea(D);this.stats.setAttribute("readonly","readonly");this.stats.addEventListener("click",function(){F.stats.select()},false);J.appendChild(D);if(L){x.makeTogleable(J,K,I).open()}J=j.createElement("tr");J.setAttribute("class","alt tit");E.appendChild(J);D=x.newCell();x.addTitle(D,C("t_stb")+":");J.appendChild(D);this.statusLine=(D=x.newCell());D.setAttribute("class","col2");this.statusText=x.addText(D,"");J.appendChild(D);J=j.createElement("tr");J.setAttribute("class","tit");E.appendChild(J);D=x.newCell();D.setAttribute("colspan","2");D.setAttribute("class","col2");K=j.createElement("div");x.addTitle(K,C("t_pre")+":");D.appendChild(K);J.appendChild(D);I=J;J=j.createElement("tr");E.appendChild(J);D=x.newCell();D.setAttribute("colspan","2");D.setAttribute("id",i.name+"_preview");J.appendChild(D);if(L){x.makeTogleable(J,K,I).open()}this.preview=D;this.previewRow=J;this.setPreview()};p.prototype={load:function(){this.setOldList(z.get("oldData"))},save:function(D){z.set("oldData",this[D+"List"].value)},setOldList:function(D){if(arguments.length>0){this.oldList.value=D}else{this.oldList.value=""}this.doIt()},setNewList:function(D){if(arguments.length>0){this.newList.value=D}else{this.newList.value=""}this.doIt()},setStats:function(D){if(arguments.length>0){this.stats.value=D}else{this.stats.value=""}},setPreview:function(D){if(arguments.length>0){this.preview.innerHTML=D}else{this.preview.innerHTML=""}},setNewListFromPage:function(){if(this.currentPageData){this.setNewList(this.currentPageData);return}var I=j.getElementById("OGameClock");if(I==null){I=j.querySelector("li.OGameClock")}var L={timestamp:q.timestamp,strDate:t.date(I.innerHTML.split("<")[0]),strTime:t.time(I.getElementsByTagName("span")[0].innerHTML),members:{}};var Q=b.list.getElementsByTagName("tbody")[0].getElementsByTagName("tr");for(var N=0;N<Q.length;N++){var M=Q[N].getElementsByTagName("td");var J=M[0].innerHTML.trim();var K;var E=M[2].getElementsByTagName("select");if(E.length>0){K=E[0].options[E[0].selectedIndex].innerHTML}else{K=M[2].innerHTML}K=K.trim();var H=M[3].getElementsByTagName("span");if(H.length>0){H=H[0]}else{H=M[3]}var O=H.getElementsByTagName("a")[0];H=H.getAttribute("title");H=parseInt(H.replace(/\D/gi,""));var D=O.getAttribute("href");D=parseInt(D.replace(/^.*searchRelId\=(\d+)(\D.*)?$/,"$1"));O=parseInt(O.innerHTML.replace(/\D/gi,""));var P=M[4].getElementsByTagName("a")[0].innerHTML;P=P.replace(/[^\d\:]/gi,"");var G=t.date(M[5].innerHTML);L.members[J]={i:D,r:K,s:H,p:O,c:P,d:G};var F=L.members[J];if(/NaN|undefined|null/.test(F.i+"")||(F.r)==null||typeof F.r=="undefined"||/NaN|undefined|null/.test(F.s+"")||/NaN|undefined|null/.test(F.p+"")||(!(/^\d+\:\d+\:\d+$/.test(F.c+"")))||(F.d)==null||typeof F.r=="undefined"){return false}}this.currentPageData=JSON.stringify(L);this.setNewList(this.currentPageData);return true},setErrorStatus:function(D){this.statusText.nodeValue="";this.statusLine.setAttribute("class","overmark");if(arguments.length>0){this.statusText.nodeValue=D}},setOkStatus:function(D){this.statusText.nodeValue="";this.statusLine.setAttribute("class","undermark");if(arguments.length>0){this.statusText.nodeValue=D}},setTitle:function(F,D,E){this[F+"Title"].setAttribute("class",(E)?"undermark":"overmark");this[F+"Title"].innerHTML=D},doIt:function(){v.doIt(this)}};var A=function(F){var H=this;this.section=j.createElement("div");this.section.setAttribute("class","section");var D=j.createElement("h3");var E=j.createElement("span");this.button=j.createElement("a");this.button.setAttribute("class","closed");this.button.setAttribute("href","javascript:void(0);");this.button.addEventListener("click",function(){H.toggle()},false);x.addText(E,i.name);this.button.appendChild(E);D.appendChild(this.button);this.section.appendChild(D);F.appendChild(this.section);this.sectioncontent=j.createElement("div");this.sectioncontent.setAttribute("class","sectioncontent");this.sectioncontent.setAttribute("id",i.name);this.sectioncontent.setAttribute("style","display:none;");this.content=j.createElement("div");this.content.setAttribute("class","contentz");var G=j.createElement("div");G.setAttribute("class","footer");this.sectioncontent.appendChild(this.content);this.sectioncontent.appendChild(G);F.appendChild(this.sectioncontent);this.form=null;this.canLoad=true;this.wTime=30;this.toggleTimer=null};var n=function(F){var D=0,E=0;if(F.offsetParent){do{D+=F.offsetLeft;E+=F.offsetTop}while(F=F.offsetParent)}return{l:D,t:E}};A.prototype={loadForm:function(){this.canLoad=false;if(!b.ready){this.wTime=Math.round(this.wTime*1.1);var D=this;setTimeout(function(){D.loadForm()},this.wTime);return}this.form=new p(this.content);this.form.setErrorStatus(C("e_nod"));if(!this.form.setNewListFromPage()){this.sectioncontent.innerHTML='<div style="color:red;text-align:center;font-weigth:bold;padding:30px">'+C("e_oga")+"</div>"}this.form.load();if(this.form.oldList.value==""){this.form.save("new");this.form.load()}},toggle:function(){if(this.canLoad){this.loadForm()}if(this.button.getAttribute("class")=="closed"){this.button.setAttribute("class","opened");this.sectioncontent.setAttribute("style","display:block;");var E=n(this.section);for(var D=10;D<=100;D+=30){setTimeout(function(){try{d.scroll(E.l,E.t)}catch(F){}},D)}}else{this.button.setAttribute("class","closed");this.sectioncontent.setAttribute("style","display:none;")}}};i.domWait=30;i.domLoader=function(){clearTimeout(this.domTimer);if(j.getElementById("allyInternText")){delete this.dom;this.dom=new A(j.getElementById("eins"))}else{this.domWait=Math.round(this.domWait*1.1);this.domTimer=setTimeout(function(){i.domLoader()},this.domWait)}};i.init=function(){this.domLoader();try{j.querySelector("a.navi.overview").addEventListener("click",function(){i.domWait=30;i.domLoader()},false);var D=j.querySelector("#form_assignRank a.save_bigger");if(D){D.addEventListener("click",function(){i.domWait=30;i.domTimer=setTimeout(function(){i.domLoader()},500)},false)}}catch(E){}};i.init()};var l=function(){if(arguments.callee.done){return}arguments.callee.done=true;if(c){clearInterval(c)}a()};if(j.addEventListener){j.addEventListener("DOMContentLoaded",l,false)}if(/WebKit/i.test(d.navigator.userAgent)){var c=setInterval(function(){if(/loaded|complete/.test(j.readyState)){l()}},10)}d.onload=l})();